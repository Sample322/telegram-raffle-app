{"ast":null,"code":"import React,{useState,useEffect}from'react';import{useParams,useNavigate}from'react-router-dom';import{ArrowLeftIcon}from'@heroicons/react/24/outline';import api from'../services/api';import SlotReelComponent from'../components/SlotReelComponent';import{toast}from'react-hot-toast';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function LiveRafflePage(){const{id}=useParams();const navigate=useNavigate();const[raffle,setRaffle]=useState(null);const[participants,setParticipants]=useState([]);const[currentRound,setCurrentRound]=useState(null);const[winners,setWinners]=useState([]);const[isSpinning,setIsSpinning]=useState(false);const[socket,setSocket]=useState(null);const[countdown,setCountdown]=useState(null);const[loading,setLoading]=useState(true);const[connectionStatus,setConnectionStatus]=useState('connecting');useEffect(()=>{loadRaffleData();connectWebSocket();return()=>{if(socket){socket.close();}};},[id]);const loadRaffleData=async()=>{try{const[raffleRes,participantsRes]=await Promise.all([api.get(`/raffles/${id}`),api.get(`/raffles/${id}/participants`)]);setRaffle(raffleRes.data);setParticipants(participantsRes.data);// Check if we have any previous winners\nif(raffleRes.data.is_completed){const completedRes=await api.get('/raffles/completed?limit=50');const completedRaffle=completedRes.data.find(r=>r.id===parseInt(id));if(completedRaffle&&completedRaffle.winners){setWinners(completedRaffle.winners);}}setLoading(false);}catch(error){console.error('Error loading raffle:',error);toast.error('Ошибка загрузки розыгрыша');setLoading(false);}};const connectWebSocket=()=>{const wsUrl=`${process.env.REACT_APP_WS_URL||'ws://localhost:8000'}/api/ws/${id}`;console.log('Connecting to WebSocket:',wsUrl);const ws=new WebSocket(wsUrl);ws.onopen=()=>{console.log('Connected to WebSocket');setConnectionStatus('connected');// Send ping every 30 seconds to keep connection alive\nconst pingInterval=setInterval(()=>{if(ws.readyState===WebSocket.OPEN){ws.send(JSON.stringify({type:'ping'}));}},30000);ws.pingInterval=pingInterval;};ws.onmessage=event=>{const data=JSON.parse(event.data);console.log('WebSocket message:',data);switch(data.type){case'connection_established':if(data.raffle.is_completed){setConnectionStatus('completed');}break;case'raffle_starting':toast.success('Розыгрыш начинается!');break;case'wheel_start':let orderedParticipants=[];if(data.participant_order&&data.participant_order.length>0){orderedParticipants=data.participant_order.map(tid=>{const participant=data.participants.find(p=>p.id===tid);if(!participant){console.error(`Participant with id ${tid} not found in participants list`);}return participant;}).filter(Boolean);}else{console.error('No participant_order received from backend!');orderedParticipants=data.participants;}console.log('Slot participants order:',orderedParticipants.map(p=>({id:p.id,username:p.username})));console.log('Target offset from server:',data.target_offset);setCurrentRound({position:data.position,prize:data.prize,participants:orderedParticipants,targetOffset:data.target_offset// Изменено с targetAngle\n});setIsSpinning(true);toast(`🎰 Разыгрывается ${data.position} место!`);break;case'winner_confirmed':setWinners(prev=>{const updated=[...prev];const existingIndex=updated.findIndex(w=>w.position===data.position);if(existingIndex>=0){updated[existingIndex]=data;}else{updated.push(data);}return updated;});setIsSpinning(false);toast.success(`🎉 Победитель ${data.position} места: @${data.winner.username||data.winner.first_name}!`);break;// В switch statement для ws.onmessage добавить:\ncase'round_complete':console.log(`Round ${data.position} completed`);// Обновляем состояние для следующего раунда\nsetCurrentRound(prev=>{if(prev&&prev.position===data.position){return null;// Сбрасываем только если это тот же раунд\n}return prev;});setIsSpinning(false);// Обновляем участников, исключая победителя\nif(data.winner_id){setParticipants(prev=>prev.filter(p=>p.telegram_id!==data.winner_id));}break;case'raffle_complete':setWinners(data.winners);setConnectionStatus('completed');setCurrentRound(null);setIsSpinning(false);toast.success('🎊 Розыгрыш завершен!');// Отключаем WebSocket после завершения\nif(socket&&socket.readyState===WebSocket.OPEN){socket.close();}break;case'countdown':setCountdown(data.seconds);break;case'error':toast.error(data.message);break;default:break;}};ws.onerror=error=>{console.error('WebSocket error:',error);setConnectionStatus('error');toast.error('Ошибка подключения');};ws.onclose=()=>{console.log('WebSocket disconnected');setConnectionStatus('disconnected');// Clear ping interval\nif(ws.pingInterval){clearInterval(ws.pingInterval);}// Try to reconnect after 5 seconds if raffle is not completed\nif(!(raffle!==null&&raffle!==void 0&&raffle.is_completed)){setTimeout(()=>{console.log('Attempting to reconnect...');connectWebSocket();},5000);}};setSocket(ws);};const formatCountdown=seconds=>{const minutes=Math.floor(seconds/60);const secs=seconds%60;return`${minutes}:${secs.toString().padStart(2,'0')}`;};if(loading){return/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center justify-center h-screen bg-gradient-to-br from-purple-600 to-blue-600\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-white\",children:\"\\u0417\\u0430\\u0433\\u0440\\u0443\\u0437\\u043A\\u0430 \\u0440\\u043E\\u0437\\u044B\\u0433\\u0440\\u044B\\u0448\\u0430...\"})]})});}if(!raffle){return/*#__PURE__*/_jsx(\"div\",{className:\"min-h-screen bg-gray-50 p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"container mx-auto text-center\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-600\",children:\"\\u0420\\u043E\\u0437\\u044B\\u0433\\u0440\\u044B\\u0448 \\u043D\\u0435 \\u043D\\u0430\\u0439\\u0434\\u0435\\u043D\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate('/'),className:\"mt-4 text-blue-600 hover:underline\",children:\"\\u0412\\u0435\\u0440\\u043D\\u0443\\u0442\\u044C\\u0441\\u044F \\u043D\\u0430 \\u0433\\u043B\\u0430\\u0432\\u043D\\u0443\\u044E\"})]})});}/* -------------------------------------------------------------\r\n   Формируем список участников для колеса,\r\n   исключая тех, кто уже есть в winners.\r\n------------------------------------------------------------- */const eliminatedIds=winners.map(w=>{var _w$winner,_w$user,_w$user2;return((_w$winner=w.winner)===null||_w$winner===void 0?void 0:_w$winner.id)||(// если winner приходит так\n(_w$user=w.user)===null||_w$user===void 0?void 0:_w$user.telegram_id)||(// или так\n(_w$user2=w.user)===null||_w$user2===void 0?void 0:_w$user2.id)// или так\n;});const wheelParticipants=((currentRound===null||currentRound===void 0?void 0:currentRound.participants)||participants.map(p=>({id:p.telegram_id,username:p.username,first_name:p.first_name,last_name:p.last_name}))).filter(p=>!eliminatedIds.includes(p.id));return/*#__PURE__*/_jsxs(\"div\",{className:\"min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 text-white\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"sticky top-0 z-50 bg-white/10 backdrop-blur-sm\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"container mx-auto px-4 py-3 flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate('/'),className:\"p-2 rounded-lg hover:bg-white/20 transition-colors\",\"aria-label\":\"\\u041D\\u0430\\u0437\\u0430\\u0434\",children:/*#__PURE__*/_jsx(ArrowLeftIcon,{className:\"h-5 w-5 text-white\"})}),/*#__PURE__*/_jsx(\"h1\",{className:\"ml-3 text-lg font-semibold text-white truncate\",children:raffle.title})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:`w-2 h-2 rounded-full ${connectionStatus==='connected'?'bg-green-400':connectionStatus==='error'?'bg-red-400':'bg-yellow-400'} animate-pulse`}),/*#__PURE__*/_jsx(\"span\",{className:\"text-xs opacity-75\",children:connectionStatus==='connected'?'Подключено':connectionStatus==='error'?'Ошибка':connectionStatus==='completed'?'Завершен':'Подключение...'})]})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"container mx-auto p-4\",children:[countdown&&countdown>0&&/*#__PURE__*/_jsxs(\"div\",{className:\"text-center mb-8 animate-pulse\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-2xl mb-2\",children:\"\\uD83C\\uDFB0 \\u0420\\u043E\\u0437\\u044B\\u0433\\u0440\\u044B\\u0448 \\u043D\\u0430\\u0447\\u043D\\u0435\\u0442\\u0441\\u044F \\u0447\\u0435\\u0440\\u0435\\u0437:\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-6xl font-bold\",children:formatCountdown(countdown)})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid lg:grid-cols-3 gap-8\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"lg:col-span-2\",children:/*#__PURE__*/_jsx(\"div\",{className:\"bg-white rounded-lg p-8 shadow-2xl\",children:wheelParticipants.length>0?/*#__PURE__*/_jsx(SlotReelComponent,{participants:wheelParticipants,isSpinning:isSpinning,currentPrize:currentRound?{position:currentRound.position,prize:currentRound.prize}:null,socket:socket,raffleId:id,wheelSpeed:(raffle===null||raffle===void 0?void 0:raffle.wheel_speed)||'fast',targetOffset:currentRound===null||currentRound===void 0?void 0:currentRound.targetOffset// Изменено с targetAngle\n,onComplete:winner=>console.log('Winner selected:',winner)}):/*#__PURE__*/_jsxs(\"div\",{className:\"text-center text-gray-600 py-20\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-xl mb-4\",children:\"\\u041E\\u0436\\u0438\\u0434\\u0430\\u043D\\u0438\\u0435 \\u0443\\u0447\\u0430\\u0441\\u0442\\u043D\\u0438\\u043A\\u043E\\u0432...\"}),/*#__PURE__*/_jsxs(\"p\",{children:[\"\\u0422\\u0435\\u043A\\u0443\\u0449\\u0435\\u0435 \\u043A\\u043E\\u043B\\u0438\\u0447\\u0435\\u0441\\u0442\\u0432\\u043E \\u0443\\u0447\\u0430\\u0441\\u0442\\u043D\\u0438\\u043A\\u043E\\u0432: \",participants.length]}),participants.length<Object.keys(raffle.prizes).length&&/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-red-600 mt-2\",children:[\"\\u041C\\u0438\\u043D\\u0438\\u043C\\u0443\\u043C \\u0443\\u0447\\u0430\\u0441\\u0442\\u043D\\u0438\\u043A\\u043E\\u0432 \\u0434\\u043B\\u044F \\u0440\\u043E\\u0437\\u044B\\u0433\\u0440\\u044B\\u0448\\u0430: \",Object.keys(raffle.prizes).length]})]})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white/10 backdrop-blur rounded-lg p-6\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-2xl font-semibold mb-4\",children:\"\\uD83C\\uDFC6 \\u041F\\u0440\\u0438\\u0437\\u043E\\u0432\\u044B\\u0435 \\u043C\\u0435\\u0441\\u0442\\u0430\"}),/*#__PURE__*/_jsx(\"div\",{className:\"space-y-3\",children:Object.entries(raffle.prizes).sort((_ref,_ref2)=>{let[a]=_ref;let[b]=_ref2;return parseInt(a)-parseInt(b);})// Сортируем по возрастанию (1, 2, 3...)\n.map(_ref3=>{var _winner$winner,_winner$user;let[position,prize]=_ref3;const winner=winners.find(w=>w.position===parseInt(position));const isCurrentRound=(currentRound===null||currentRound===void 0?void 0:currentRound.position)===parseInt(position);return/*#__PURE__*/_jsxs(\"div\",{className:`p-4 rounded-lg transition-all duration-300 ${winner?'bg-green-500/30 scale-105':isCurrentRound?'bg-yellow-500/30 animate-pulse':'bg-white/10'}`,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"font-semibold flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"span\",{children:[position,\" \\u043C\\u0435\\u0441\\u0442\\u043E\"]}),position==='1'&&'🥇',position==='2'&&'🥈',position==='3'&&'🥉']}),/*#__PURE__*/_jsx(\"div\",{className:\"text-sm opacity-90\",children:prize}),winner&&/*#__PURE__*/_jsxs(\"div\",{className:\"text-lg mt-2 font-bold\",children:[\"\\uD83C\\uDF89 @\",((_winner$winner=winner.winner)===null||_winner$winner===void 0?void 0:_winner$winner.username)||((_winner$user=winner.user)===null||_winner$user===void 0?void 0:_winner$user.username)||'Победитель']}),isCurrentRound&&!winner&&/*#__PURE__*/_jsx(\"div\",{className:\"text-sm mt-2 animate-pulse\",children:\"\\uD83C\\uDFB0 \\u0420\\u0430\\u0437\\u044B\\u0433\\u0440\\u044B\\u0432\\u0430\\u0435\\u0442\\u0441\\u044F \\u0441\\u0435\\u0439\\u0447\\u0430\\u0441...\"})]},position);})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-8 bg-white/10 backdrop-blur rounded-lg p-6 text-center\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-2xl font-semibold mb-2\",children:\"\\uD83D\\uDC65 \\u0412\\u0441\\u0435\\u0433\\u043E \\u0443\\u0447\\u0430\\u0441\\u0442\\u043D\\u0438\\u043A\\u043E\\u0432\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-4xl font-bold\",children:participants.length})]}),connectionStatus==='completed'&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-8 text-center\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white/20 backdrop-blur rounded-lg p-8\",children:[/*#__PURE__*/_jsx(\"h2\",{className:\"text-3xl font-bold mb-4\",children:\"\\uD83C\\uDF8A \\u0420\\u043E\\u0437\\u044B\\u0433\\u0440\\u044B\\u0448 \\u0437\\u0430\\u0432\\u0435\\u0440\\u0448\\u0435\\u043D!\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xl mb-4\",children:\"\\u041F\\u043E\\u0437\\u0434\\u0440\\u0430\\u0432\\u043B\\u044F\\u0435\\u043C \\u0432\\u0441\\u0435\\u0445 \\u043F\\u043E\\u0431\\u0435\\u0434\\u0438\\u0442\\u0435\\u043B\\u0435\\u0439!\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>navigate('/'),className:\"bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors\",children:\"\\u0412\\u0435\\u0440\\u043D\\u0443\\u0442\\u044C\\u0441\\u044F \\u043D\\u0430 \\u0433\\u043B\\u0430\\u0432\\u043D\\u0443\\u044E\"})]})})]})]});}export default LiveRafflePage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}